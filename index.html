<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Flow Field Brightness Pills</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flow Field Camera">
    <style>
      body { margin: 0; overflow: hidden; background: black; }
      canvas { display: block; }
      #captureButton, #clearButton, #saveButton {
        position: absolute;
        bottom: 40px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10;
      }
      #captureButton {
        background: white;
        width: 70px;
        height: 70px;
        left: 50%;
        transform: translateX(-50%);
      }
      #clearButton {
        right: 20px;
        bottom: 50px;
        width: 50px;
        height: 50px;
        background: red;
        border-radius: 10px;
      }
      #saveButton {
        left: 20px;
        bottom: 50px;
        width: 50px;
        height: 50px;
        background: green;
        border-radius: 10px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  </head>
  <body>
    <button id="captureButton"></button>
    <button id="clearButton"></button>
    <button id="saveButton"></button>
    <script>
      let video;
      let capturedImage;
      let particles = [];

      function setup() {
        createCanvas(windowWidth, windowHeight);

        video = createCapture({ video: { facingMode: { exact: "environment" } }, audio: false });
        video.hide();

        for (let i = 0; i < 200; i++) {
          particles.push(new Particle());
        }

        document.getElementById('captureButton').addEventListener('click', () => {
          capturedImage = getCroppedVideo();
        });

        document.getElementById('clearButton').addEventListener('click', () => {
          clear();
          background(0);
        });

        document.getElementById('saveButton').addEventListener('click', () => {
          saveCanvas('flow_field_artwork', 'png');
        });

        background(0);
      }

      function draw() {
        if (capturedImage) {
          for (let p of particles) {
            p.update();
            p.show();
            p.reset();
          }
        } else if (video.loadedmetadata) {
          drawCroppedVideo(video);
        }
      }

      function drawCroppedVideo(src) {
        let vidAspect = src.width / src.height;
        let canvasAspect = width / height;

        if (vidAspect > canvasAspect) {
          let newW = src.height * canvasAspect;
          let startX = (src.width - newW) / 2;
          image(src, 0, 0, width, height, startX, 0, newW, src.height);
        } else {
          let newH = src.width / canvasAspect;
          let startY = (src.height - newH) / 2;
          image(src, 0, 0, width, height, 0, startY, src.width, newH);
        }
      }

      function getCroppedVideo() {
        let gfx = createGraphics(video.width, video.height);
        gfx.image(video, 0, 0);
        return gfx.get();
      }

      class Particle {
        constructor() {
          this.pos = createVector(random(width), random(height));
        }
        update() {
          let angle = noise(this.pos.x * 0.005, this.pos.y * 0.005) * TWO_PI;
          this.vel = p5.Vector.fromAngle(angle);
        }
        show() {
          if (capturedImage) {
            let px = floor(map(this.pos.x, 0, width, 0, capturedImage.width));
            let py = floor(map(this.pos.y, 0, height, 0, capturedImage.height));
            let c = capturedImage.get(px, py);
            let b = brightness(c);

            // Reverse: lighter = bigger, darker = smaller
            let sw = map(b, 0, 100, 3, 10);
            let len = sw * 1.2; // pill shape

            stroke(c);
            strokeWeight(sw);
            let angle = noise(this.pos.x * 0.01, this.pos.y * 0.01) * TWO_PI;
            let x2 = this.pos.x + cos(angle) * len;
            let y2 = this.pos.y + sin(angle) * len;
            line(this.pos.x, this.pos.y, x2, y2);
          }
        }
        reset() {
          this.pos = createVector(random(width), random(height));
        }
      }
    </script>
  </body>
</html>
