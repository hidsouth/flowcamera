<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Flow Field Darkness Reactive Pills</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flow Field Camera">
    <style>
      body { margin: 0; overflow: hidden; background: black; }
      canvas { display: block; }
      #captureButton, #clearButton, #saveButton {
        position: absolute;
        bottom: 40px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10;
      }
      #captureButton {
        background: white;
        width: 70px;
        height: 70px;
        left: 50%;
        transform: translateX(-50%);
      }
      #clearButton {
        right: 20px;
        bottom: 50px;
        width: 50px;
        height: 50px;
        background: red;
        border-radius: 10px;
      }
      #saveButton {
        left: 20px;
        bottom: 50px;
        width: 50px;
        height: 50px;
        background: green;
        border-radius: 10px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  </head>
  <body>
    <button id="captureButton"></button>
    <button id="clearButton"></button>
    <button id="saveButton"></button>
    <script>
      let video;
      let capturedImage;
      let particles = [];

      function setup() {
        createCanvas(windowWidth, windowHeight);

        video = createCapture({ video: { facingMode: { exact: "environment" } }, audio: false });
        video.size(width, height);
        video.hide();

        for (let i = 0; i < 200; i++) {
          particles.push(new Particle());
        }

        document.getElementById('captureButton').addEventListener('click', () => {
          capturedImage = video.get();
        });

        document.getElementById('clearButton').addEventListener('click', () => {
          clear();
          background(0);
        });

        document.getElementById('saveButton').addEventListener('click', () => {
          saveCanvas('flow_field_artwork', 'png'); // saves to Photos if user taps “Save Image”
        });

        background(0);
      }

      function draw() {
        if (capturedImage) {
          for (let p of particles) {
            p.update();
            p.show();
            p.reset();
          }
        } else if (video) {
          image(video, 0, 0, width, height);
        }
      }

      class Particle {
        constructor() {
          this.pos = createVector(random(width), random(height));
        }
        update() {
          let angle = noise(this.pos.x * 0.005, this.pos.y * 0.005) * TWO_PI;
          this.vel = p5.Vector.fromAngle(angle);
        }
        show() {
          if (capturedImage) {
            let px = constrain(floor(this.pos.x), 0, capturedImage.width - 1);
            let py = constrain(floor(this.pos.y), 0, capturedImage.height - 1);
            let c = capturedImage.get(px, py);
            let b = brightness(c);
            let darkness = 100 - b;
            let sw = map(darkness, 0, 100, 2, 14);
            let len = sw * 1.5; // pill-like lines

            stroke(c);
            strokeWeight(sw);
            let angle = noise(this.pos.x * 0.01, this.pos.y * 0.01) * TWO_PI;
            let x2 = this.pos.x + cos(angle) * len;
            let y2 = this.pos.y + sin(angle) * len;
            line(this.pos.x, this.pos.y, x2, y2);
          }
        }
        reset() {
          this.pos = createVector(random(width), random(height));
        }
      }
    </script>
  </body>
</html>
