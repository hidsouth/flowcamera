<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Field Darkness Reactive Pills (50mm Crop)</title>

    <!-- Allow fullscreen "app mode" on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flow Field Camera">

    <!-- Optional: custom home screen icon -->
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }
        canvas {
            display: block;
        }
        #captureButton, #clearButton {
            position: absolute;
            bottom: 40px;
            border: none;
            border-radius: 50%;
            background: white;
            width: 70px;
            height: 70px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 10;
        }
        #clearButton {
            left: auto;
            right: 20px;
            bottom: 50px;
            width: 50px;
            height: 50px;
            background: red;
            border-radius: 10px;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>
<body>

    <!-- Capture Button -->
    <button id="captureButton"></button>

    <!-- Clear Button -->
    <button id="clearButton"></button>

    <script>
        let video;
        let capturedImage;
        let particles = [];

        function setup() {
            createCanvas(windowWidth, windowHeight);

            // Set up video capture
            video = createCapture({ video: { facingMode: { exact: "environment" } }, audio: false });
            video.size(width, height);
            video.hide();

            // Create particles
            for (let i = 0; i < 200; i++) {
                particles.push(new Particle());
            }

            // Capture button functionality
            document.getElementById('captureButton').addEventListener('click', () => {
                let cropW = video.width * 0.6; // crop to ~60% width (narrower FOV)
                let cropH = video.height * 0.6; // same for height to keep aspect
                let startX = (video.width - cropW) / 2;
                let startY = (video.height - cropH) / 2;
                capturedImage = video.get(startX, startY, cropW, cropH);
            });

            // Clear button functionality
            document.getElementById('clearButton').addEventListener('click', () => {
                clear();
                background(0);
            });

            background(0);
        }

        function draw() {
            if (capturedImage) {
                // Draw the captured frame with particles
                for (let p of particles) {
                    p.update();
                    p.show();
                    p.reset();
                }
            } else if (video) {
                // Draw cropped live preview
                let cropW = video.width * 0.6;
                let cropH = video.height * 0.6;
                let startX = (video.width - cropW) / 2;
                let startY = (video.height - cropH) / 2;
                image(video, 0, 0, width, height, startX, startY, cropW, cropH);
            }
        }

        // Particle class for flow field effect
        class Particle {
            constructor() {
                this.pos = createVector(random(width), random(height));
            }

            update() {
                let angle = noise(this.pos.x * 0.005, this.pos.y * 0.005) * TWO_PI;
                this.vel = p5.Vector.fromAngle(angle);
            }

            show() {
                if (capturedImage) {
                    let px = constrain(floor(map(this.pos.x, 0, width, 0, capturedImage.width)), 0, capturedImage.width - 1);
                    let py = constrain(floor(map(this.pos.y, 0, height, 0, capturedImage.height)), 0, capturedImage.height - 1);
                    let c = capturedImage.get(px, py);
                    let b = brightness(c);
                    let darkness = 100 - b;
                    let sw = map(darkness, 0, 100, 2, 14);
                    let len = sw * 1.5; // pill length

                    stroke(c);
                    strokeWeight(sw);
                    let angle = noise(this.pos.x * 0.01, this.pos.y * 0.01) * TWO_PI;
                    let x2 = this.pos.x + cos(angle) * len;
                    let y2 = this.pos.y + sin(angle) * len;
                    line(this.pos.x, this.pos.y, x2, y2);
                }
            }

            reset() {
                this.pos = createVector(random(width), random(height));
            }
        }
    </script>

</body>
</html>
